{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "81ab4bb7-8ff3-49c0-8783-e3683cfa205d",
   "metadata": {},
   "outputs": [],
   "source": [
    "import os\n",
    "%load_ext autoreload\n",
    "%autoreload 2\n",
    "import pandas as pd\n",
    "import pyspark\n",
    "import pyarrow\n",
    "\n",
    "from pyspark.sql import SparkSession\n",
    "from pyspark.sql.functions import *"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "a73cb19f-c5ec-440e-91b4-da11d92c2565",
   "metadata": {},
   "outputs": [],
   "source": [
    "os.environ['SPARK_HOME'] = 'C:/Users/saul2/Spark_DF/spark-3.5.5-bin-hadoop3'\n",
    "os.environ['HADOOP_HOME'] = 'C:/Users/saul2/Spark_DF/spark-3.5.5-bin-hadoop3'\n",
    "os.environ['JAVA_HOME'] = 'C:/Program Files/Java/jdk1.8.0_202'"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "879f2598-b179-4413-b906-964b2a3e07d4",
   "metadata": {},
   "outputs": [],
   "source": [
    "#spark = SparkSession.builder.appName(\"Practice\").\\\n",
    "#    .config(\"spark.hadoop.fs.file.impl\", \"org.apache.hadoop.fs.LocalFileSystem\") \\\n",
    "#    .config(\"spark.hadoop.hadoop.native.io\", \"false\").getOrCreate()\n",
    "spark = SparkSession.builder.appName(\"Practice\").getOrCreate()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4e3ee73f-911d-4ea3-8606-ee8e1c4358af",
   "metadata": {},
   "outputs": [],
   "source": [
    "csv_file = 'Students_Grading_Dataset.csv'\n",
    "df = spark.read.option(\"header\", True).csv(csv_file)\n",
    "df.createOrReplaceTempView(\"Students\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 149,
   "id": "314bfa30-71fe-49e3-90f6-9efaf243d019",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Rename columns\n",
    "df = df.withColumnRenamed('Attendance (%)', 'Attendance_Percentage') \\\n",
    "        .withColumnRenamed('Stress_Level (1-10)', 'Stress_Level')\n",
    "# Create table after clean upo\n",
    "df.createOrReplaceTempView(\"Students\")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 151,
   "id": "eba66088-11b6-4f48-920b-439b38b61874",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "+--------------------------+---------+-------+\n",
      "|col_name                  |data_type|comment|\n",
      "+--------------------------+---------+-------+\n",
      "|Student_ID                |string   |NULL   |\n",
      "|First_Name                |string   |NULL   |\n",
      "|Last_Name                 |string   |NULL   |\n",
      "|Email                     |string   |NULL   |\n",
      "|Gender                    |string   |NULL   |\n",
      "|Age                       |string   |NULL   |\n",
      "|Department                |string   |NULL   |\n",
      "|Attendance_Percentage     |string   |NULL   |\n",
      "|Midterm_Score             |string   |NULL   |\n",
      "|Final_Score               |string   |NULL   |\n",
      "|Assignments_Avg           |string   |NULL   |\n",
      "|Quizzes_Avg               |string   |NULL   |\n",
      "|Participation_Score       |string   |NULL   |\n",
      "|Projects_Score            |string   |NULL   |\n",
      "|Total_Score               |string   |NULL   |\n",
      "|Grade                     |string   |NULL   |\n",
      "|Study_Hours_per_Week      |string   |NULL   |\n",
      "|Extracurricular_Activities|string   |NULL   |\n",
      "|Internet_Access_at_Home   |string   |NULL   |\n",
      "|Parent_Education_Level    |string   |NULL   |\n",
      "|Family_Income_Level       |string   |NULL   |\n",
      "|Stress_Level              |string   |NULL   |\n",
      "|Sleep_Hours_per_Night     |string   |NULL   |\n",
      "+--------------------------+---------+-------+\n",
      "\n"
     ]
    }
   ],
   "source": [
    "# Show Column Names\n",
    "query = 'DESC STUDENTS'\n",
    "result = spark.sql(query)\n",
    "result.show(30, truncate=False)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "6a85ad15-efa1-4a8e-8785-c15ad287213a",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Students Older than 21\n",
    "query = \"SELECT * FROM STUDENTS WHERE AGE > 21\"\n",
    "result = spark.sql(query)\n",
    "#result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 303,
   "id": "20753c28-02c9-4e6c-9681-2fc58f93f992",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Make a directory for my files\n",
    "output_dir = 'results'"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 309,
   "id": "0fa5f5b0-17b1-4869-ac12-4ca1880e786a",
   "metadata": {},
   "outputs": [],
   "source": [
    "if not os.path.exists(output_dir):\n",
    "    os.makedirs(output_dir)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 315,
   "id": "434ff6e5-2504-4ae2-8b4f-b31d7b434680",
   "metadata": {},
   "outputs": [
    {
     "ename": "ConnectionRefusedError",
     "evalue": "[WinError 10061] No connection could be made because the target machine actively refused it",
     "output_type": "error",
     "traceback": [
      "\u001b[1;31m---------------------------------------------------------------------------\u001b[0m",
      "\u001b[1;31mConnectionRefusedError\u001b[0m                    Traceback (most recent call last)",
      "Cell \u001b[1;32mIn[315], line 14\u001b[0m\n\u001b[0;32m      1\u001b[0m \u001b[38;5;66;03m# Students with a total_score higher than their department_avg\u001b[39;00m\n\u001b[0;32m      2\u001b[0m query \u001b[38;5;241m=\u001b[39m \u001b[38;5;124m'''\u001b[39m\n\u001b[0;32m      3\u001b[0m \u001b[38;5;124m    WITH DEPT_AVG AS (\u001b[39m\n\u001b[0;32m      4\u001b[0m \u001b[38;5;124m        SELECT DEPARTMENT, ROUND(AVG(TOTAL_SCORE),2) AVG_SCORE\u001b[39m\n\u001b[1;32m   (...)\u001b[0m\n\u001b[0;32m     12\u001b[0m \u001b[38;5;124m    ORDER BY STUDENTS.DEPARTMENT, STUDENT_ID\u001b[39m\n\u001b[0;32m     13\u001b[0m \u001b[38;5;124m    \u001b[39m\u001b[38;5;124m'''\u001b[39m\n\u001b[1;32m---> 14\u001b[0m result \u001b[38;5;241m=\u001b[39m \u001b[43mspark\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43msql\u001b[49m\u001b[43m(\u001b[49m\u001b[43mquery\u001b[49m\u001b[43m)\u001b[49m\n\u001b[0;32m     15\u001b[0m result\u001b[38;5;241m.\u001b[39mshow()\n\u001b[0;32m     16\u001b[0m pandas_df \u001b[38;5;241m=\u001b[39m result\u001b[38;5;241m.\u001b[39mtoPandas()\n",
      "File \u001b[1;32m~\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\pyspark\\sql\\session.py:1628\u001b[0m, in \u001b[0;36mSparkSession.sql\u001b[1;34m(self, sqlQuery, args, **kwargs)\u001b[0m\n\u001b[0;32m   1626\u001b[0m     \u001b[38;5;28;01melse\u001b[39;00m:\n\u001b[0;32m   1627\u001b[0m         \u001b[38;5;28;01massert\u001b[39;00m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39m_jvm \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;129;01mnot\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m\n\u001b[1;32m-> 1628\u001b[0m         litArgs \u001b[38;5;241m=\u001b[39m \u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43m_jvm\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mPythonUtils\u001b[49m\u001b[38;5;241m.\u001b[39mtoArray(\n\u001b[0;32m   1629\u001b[0m             [_to_java_column(lit(v)) \u001b[38;5;28;01mfor\u001b[39;00m v \u001b[38;5;129;01min\u001b[39;00m (args \u001b[38;5;129;01mor\u001b[39;00m [])]\n\u001b[0;32m   1630\u001b[0m         )\n\u001b[0;32m   1631\u001b[0m     \u001b[38;5;28;01mreturn\u001b[39;00m DataFrame(\u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39m_jsparkSession\u001b[38;5;241m.\u001b[39msql(sqlQuery, litArgs), \u001b[38;5;28mself\u001b[39m)\n\u001b[0;32m   1632\u001b[0m \u001b[38;5;28;01mfinally\u001b[39;00m:\n",
      "File \u001b[1;32m~\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\py4j\\java_gateway.py:1712\u001b[0m, in \u001b[0;36mJVMView.__getattr__\u001b[1;34m(self, name)\u001b[0m\n\u001b[0;32m   1709\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m name \u001b[38;5;241m==\u001b[39m UserHelpAutoCompletion\u001b[38;5;241m.\u001b[39mKEY:\n\u001b[0;32m   1710\u001b[0m     \u001b[38;5;28;01mreturn\u001b[39;00m UserHelpAutoCompletion()\n\u001b[1;32m-> 1712\u001b[0m answer \u001b[38;5;241m=\u001b[39m \u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43m_gateway_client\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43msend_command\u001b[49m\u001b[43m(\u001b[49m\n\u001b[0;32m   1713\u001b[0m \u001b[43m    \u001b[49m\u001b[43mproto\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mREFLECTION_COMMAND_NAME\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;241;43m+\u001b[39;49m\n\u001b[0;32m   1714\u001b[0m \u001b[43m    \u001b[49m\u001b[43mproto\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mREFL_GET_UNKNOWN_SUB_COMMAND_NAME\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;241;43m+\u001b[39;49m\u001b[43m \u001b[49m\u001b[43mname\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;241;43m+\u001b[39;49m\u001b[43m \u001b[49m\u001b[38;5;124;43m\"\u001b[39;49m\u001b[38;5;130;43;01m\\n\u001b[39;49;00m\u001b[38;5;124;43m\"\u001b[39;49m\u001b[43m \u001b[49m\u001b[38;5;241;43m+\u001b[39;49m\u001b[43m \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43m_id\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;241;43m+\u001b[39;49m\n\u001b[0;32m   1715\u001b[0m \u001b[43m    \u001b[49m\u001b[38;5;124;43m\"\u001b[39;49m\u001b[38;5;130;43;01m\\n\u001b[39;49;00m\u001b[38;5;124;43m\"\u001b[39;49m\u001b[43m \u001b[49m\u001b[38;5;241;43m+\u001b[39;49m\u001b[43m \u001b[49m\u001b[43mproto\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mEND_COMMAND_PART\u001b[49m\u001b[43m)\u001b[49m\n\u001b[0;32m   1716\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m answer \u001b[38;5;241m==\u001b[39m proto\u001b[38;5;241m.\u001b[39mSUCCESS_PACKAGE:\n\u001b[0;32m   1717\u001b[0m     \u001b[38;5;28;01mreturn\u001b[39;00m JavaPackage(name, \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39m_gateway_client, jvm_id\u001b[38;5;241m=\u001b[39m\u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39m_id)\n",
      "File \u001b[1;32m~\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\py4j\\java_gateway.py:1036\u001b[0m, in \u001b[0;36mGatewayClient.send_command\u001b[1;34m(self, command, retry, binary)\u001b[0m\n\u001b[0;32m   1015\u001b[0m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;21msend_command\u001b[39m(\u001b[38;5;28mself\u001b[39m, command, retry\u001b[38;5;241m=\u001b[39m\u001b[38;5;28;01mTrue\u001b[39;00m, binary\u001b[38;5;241m=\u001b[39m\u001b[38;5;28;01mFalse\u001b[39;00m):\n\u001b[0;32m   1016\u001b[0m \u001b[38;5;250m    \u001b[39m\u001b[38;5;124;03m\"\"\"Sends a command to the JVM. This method is not intended to be\u001b[39;00m\n\u001b[0;32m   1017\u001b[0m \u001b[38;5;124;03m       called directly by Py4J users. It is usually called by\u001b[39;00m\n\u001b[0;32m   1018\u001b[0m \u001b[38;5;124;03m       :class:`JavaMember` instances.\u001b[39;00m\n\u001b[1;32m   (...)\u001b[0m\n\u001b[0;32m   1034\u001b[0m \u001b[38;5;124;03m     if `binary` is `True`.\u001b[39;00m\n\u001b[0;32m   1035\u001b[0m \u001b[38;5;124;03m    \"\"\"\u001b[39;00m\n\u001b[1;32m-> 1036\u001b[0m     connection \u001b[38;5;241m=\u001b[39m \u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43m_get_connection\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\u001b[0;32m   1037\u001b[0m     \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[0;32m   1038\u001b[0m         response \u001b[38;5;241m=\u001b[39m connection\u001b[38;5;241m.\u001b[39msend_command(command)\n",
      "File \u001b[1;32m~\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\py4j\\clientserver.py:284\u001b[0m, in \u001b[0;36mJavaClient._get_connection\u001b[1;34m(self)\u001b[0m\n\u001b[0;32m    281\u001b[0m     \u001b[38;5;28;01mpass\u001b[39;00m\n\u001b[0;32m    283\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m connection \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m \u001b[38;5;129;01mor\u001b[39;00m connection\u001b[38;5;241m.\u001b[39msocket \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m:\n\u001b[1;32m--> 284\u001b[0m     connection \u001b[38;5;241m=\u001b[39m \u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43m_create_new_connection\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\u001b[0;32m    285\u001b[0m \u001b[38;5;28;01mreturn\u001b[39;00m connection\n",
      "File \u001b[1;32m~\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\py4j\\clientserver.py:291\u001b[0m, in \u001b[0;36mJavaClient._create_new_connection\u001b[1;34m(self)\u001b[0m\n\u001b[0;32m    287\u001b[0m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;21m_create_new_connection\u001b[39m(\u001b[38;5;28mself\u001b[39m):\n\u001b[0;32m    288\u001b[0m     connection \u001b[38;5;241m=\u001b[39m ClientServerConnection(\n\u001b[0;32m    289\u001b[0m         \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mjava_parameters, \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mpython_parameters,\n\u001b[0;32m    290\u001b[0m         \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mgateway_property, \u001b[38;5;28mself\u001b[39m)\n\u001b[1;32m--> 291\u001b[0m     \u001b[43mconnection\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mconnect_to_java_server\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\u001b[0;32m    292\u001b[0m     \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mset_thread_connection(connection)\n\u001b[0;32m    293\u001b[0m     \u001b[38;5;28;01mreturn\u001b[39;00m connection\n",
      "File \u001b[1;32m~\\AppData\\Local\\Programs\\Python\\Python313\\Lib\\site-packages\\py4j\\clientserver.py:438\u001b[0m, in \u001b[0;36mClientServerConnection.connect_to_java_server\u001b[1;34m(self)\u001b[0m\n\u001b[0;32m    435\u001b[0m \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mssl_context:\n\u001b[0;32m    436\u001b[0m     \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39msocket \u001b[38;5;241m=\u001b[39m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mssl_context\u001b[38;5;241m.\u001b[39mwrap_socket(\n\u001b[0;32m    437\u001b[0m         \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39msocket, server_hostname\u001b[38;5;241m=\u001b[39m\u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mjava_address)\n\u001b[1;32m--> 438\u001b[0m \u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43msocket\u001b[49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mconnect\u001b[49m\u001b[43m(\u001b[49m\u001b[43m(\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mjava_address\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[38;5;241;43m.\u001b[39;49m\u001b[43mjava_port\u001b[49m\u001b[43m)\u001b[49m\u001b[43m)\u001b[49m\n\u001b[0;32m    439\u001b[0m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mstream \u001b[38;5;241m=\u001b[39m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39msocket\u001b[38;5;241m.\u001b[39mmakefile(\u001b[38;5;124m\"\u001b[39m\u001b[38;5;124mrb\u001b[39m\u001b[38;5;124m\"\u001b[39m)\n\u001b[0;32m    440\u001b[0m \u001b[38;5;28mself\u001b[39m\u001b[38;5;241m.\u001b[39mis_connected \u001b[38;5;241m=\u001b[39m \u001b[38;5;28;01mTrue\u001b[39;00m\n",
      "\u001b[1;31mConnectionRefusedError\u001b[0m: [WinError 10061] No connection could be made because the target machine actively refused it"
     ]
    }
   ],
   "source": [
    "# Students with a total_score higher than their department_avg\n",
    "query = '''\n",
    "    WITH DEPT_AVG AS (\n",
    "        SELECT DEPARTMENT, ROUND(AVG(TOTAL_SCORE),2) AVG_SCORE\n",
    "        FROM STUDENTS \n",
    "        GROUP BY DEPARTMENT\n",
    "    )\n",
    "    SELECT STUDENTS.DEPARTMENT, STUDENT_ID, FIRST_NAME, LAST_NAME, TOTAL_SCORE, DEPT_AVG.AVG_SCORE\n",
    "    FROM STUDENTS, DEPT_AVG\n",
    "    WHERE STUDENTS.DEPARTMENT = DEPT_AVG.DEPARTMENT\n",
    "        AND STUDENTS.TOTAL_SCORE > DEPT_AVG.AVG_SCORE\n",
    "    ORDER BY STUDENTS.DEPARTMENT, STUDENT_ID\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "result.show()\n",
    "pandas_df = result.toPandas()\n",
    "path = os.path.join(output_dir, 'High_Scorer_Dept_Avg.parquet')\n",
    "pandas_df.to_parquet(path, engine='pyarrow') \n",
    "#path = os.path.join(output_dir, 'High_Scorer_Dept_Avg.csv')\n",
    "#pandas_df.to_csv(path, index=False)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 155,
   "id": "d65b5318-141d-4ccb-a756-e1284fc9dbc4",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Find the top 5 students with the highest final exam scores.\n",
    "query = '''\n",
    "        WITH TOP_5 AS (\n",
    "            SELECT STUDENT_ID, FIRST_NAME, LAST_NAME, FINAL_SCORE, RANK()OVER(ORDER BY FINAL_SCORE DESC) RANK\n",
    "            FROM STUDENTS\n",
    "            ORDER BY FINAL_SCORE DESC\n",
    "        )\n",
    "        SELECT STUDENT_ID, FIRST_NAME, LAST_NAME, FINAL_SCORE\n",
    "        FROM TOP_5\n",
    "        WHERE RANK <= 5\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "#result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 157,
   "id": "75e778f6-213b-484e-b6e4-e3c686776791",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Students that participated in Extracurricular Activies\n",
    "query = '''\n",
    "        SELECT *\n",
    "        FROM STUDENTS\n",
    "        WHERE Extracurricular_Activities = 'Yes'\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "#result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 159,
   "id": "d64430e4-792d-4a49-9408-b24dcd35c212",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Count how many students are in each department.\n",
    "query = '''\n",
    "        SELECT DEPARTMENT, COUNT(STUDENT_ID)\n",
    "        FROM STUDENTS\n",
    "        GROUP BY DEPARTMENT\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "#result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 161,
   "id": "9221d2a1-6732-490c-beeb-d29fa1f57231",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Show the average age of students in each department\n",
    "query = '''\n",
    "        SELECT DEPARTMENT, ROUND(AVG(AGE),2) AVG_AGE\n",
    "        FROM STUDENTS\n",
    "        GROUP BY DEPARTMENT\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "#result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 163,
   "id": "633446d9-dc8f-4ccc-852b-1c2ead0b3849",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Show males and females that scored a 70 or higher in midterm\n",
    "query = '''\n",
    "        SELECT GENDER, COUNT(STUDENT_ID)\n",
    "        FROM STUDENTS\n",
    "        WHERE MIDTERM_SCORE >= 70\n",
    "        GROUP BY GENDER\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "#result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 165,
   "id": "3084b88c-e1af-4a18-804c-4462e0f76626",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Show students who get less than 6 hours of sleep per night.\n",
    "query = '''\n",
    "        SELECT STUDENT_ID, FIRST_NAME, LAST_NAME\n",
    "        FROM STUDENTS\n",
    "        WHERE SLEEP_HOURS_PER_NIGHT <= 6\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "#result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 167,
   "id": "30589f64-1167-4a40-9d1d-fd782b375b32",
   "metadata": {},
   "outputs": [],
   "source": [
    "# List the first names and last names of all students with a grade of \"F\".\n",
    "query = '''\n",
    "        SELECT STUDENT_ID, FIRST_NAME, LAST_NAME\n",
    "        FROM STUDENTS\n",
    "        WHERE GRADE = 'F'\n",
    "        ORDER BY FIRST_NAME, LAST_NAME\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "#result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 173,
   "id": "b82198d8-9eb9-4243-8dae-54d6b05272c9",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Find students with more than 90% attendance.\n",
    "query = '''\n",
    "        SELECT STUDENT_ID, FIRST_NAME, LAST_NAME, GRADE, ATTENDANCE_PERCENTAGE\n",
    "        FROM STUDENTS\n",
    "        WHERE ATTENDANCE_PERCENTAGE >= 90\n",
    "        ORDER BY FIRST_NAME, LAST_NAME\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "#result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 181,
   "id": "bc3c17eb-cf53-44ea-b9cb-62df483fb01f",
   "metadata": {},
   "outputs": [],
   "source": [
    "# List all students who have internet access at home.\n",
    "query = '''\n",
    "        SELECT STUDENT_ID, FIRST_NAME, LAST_NAME, GRADE\n",
    "        FROM STUDENTS\n",
    "        WHERE INTERNET_ACCESS_AT_HOME = 'Yes'\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "#result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 189,
   "id": "df805e97-f822-4dff-bca8-b57d1c57089c",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Calculate the average total score for each department.\n",
    "query = '''\n",
    "        SELECT DEPARTMENT, ROUND(AVG(MIDTERM_SCORE),2) AVG_MIDTERM, ROUND(AVG(FINAL_SCORE),2) AVG_FINAL\n",
    "        FROM STUDENTS\n",
    "        GROUP BY DEPARTMENT\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "#result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 199,
   "id": "2a827a63-09d9-4f76-b543-eca4958e9722",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Find the average study hours per week by grade.\n",
    "query = '''\n",
    "        SELECT GRADE, ROUND(AVG(STUDY_HOURS_PER_WEEK),2) AVG_STUDY\n",
    "        FROM STUDENTS\n",
    "        GROUP BY GRADE\n",
    "        ORDER BY GRADE\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "#result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 205,
   "id": "44ca4d18-ab18-402e-8564-f3907ea549f0",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Which gender has a higher average participation score?\n",
    "query = '''\n",
    "        SELECT GENDER, ROUND(AVG(PARTICIPATION_SCORE),2) AVG_PARTICIPATION\n",
    "        FROM STUDENTS\n",
    "        GROUP BY GENDER\n",
    "        ORDER BY AVG_PARTICIPATION DESC\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "#result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 249,
   "id": "176654e7-d774-4593-9b86-d08cfd5875fe",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "+-------------------+----------+\n",
      "|FAMILY_INCOME_LEVEL|AVG_STRESS|\n",
      "+-------------------+----------+\n",
      "|               High|      5.46|\n",
      "|                Low|       5.5|\n",
      "|             Medium|      5.56|\n",
      "+-------------------+----------+\n",
      "\n"
     ]
    }
   ],
   "source": [
    "# What is the average stress level for students with a \"High\" family income level?\n",
    "query = '''\n",
    "        SELECT FAMILY_INCOME_LEVEL, ROUND(AVG(STRESS_LEVEL),2) AVG_STRESS\n",
    "        FROM STUDENTS\n",
    "        GROUP BY FAMILY_INCOME_LEVEL\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "#result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 223,
   "id": "50fa2e8a-ff54-4d0e-b49f-bddac9458a3c",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Show the total number of students in each parent education level.\n",
    "query = '''\n",
    "        SELECT PARENT_EDUCATION_LEVEL, COUNT(STUDENT_ID) STUDENT_COUNT\n",
    "        FROM STUDENTS\n",
    "        GROUP BY PARENT_EDUCATION_LEVEL\n",
    "        ORDER BY STUDENT_COUNT DESC\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "#result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 239,
   "id": "cfdace85-c5da-478b-8533-d6fe19b574c0",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Find the department with the highest average project score.\n",
    "query = '''\n",
    "        SELECT DEPARTMENT, ROUND(AVG(PROJECTS_SCORE),2) AVG_PROJECTS_SCORE\n",
    "        FROM STUDENTS\n",
    "        GROUP BY DEPARTMENT\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "#result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 251,
   "id": "28394efe-d031-4743-bb9d-4a28b79f7f8f",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Compare average sleep hours between students who participate in extracurriculars and those who don't.\n",
    "query = '''\n",
    "        SELECT ROUND(AVG(SLEEP_HOURS_PER_NIGHT),2) AVG_SLEEP, Extracurricular_Activities\n",
    "        FROM STUDENTS\n",
    "        GROUP BY Extracurricular_Activities\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "#result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 261,
   "id": "9f9adda8-720a-4907-94d8-081982f2a2f3",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Find how many students have both low income and a high stress level (above 7).\n",
    "query = '''\n",
    "        SELECT COUNT(STUDENT_ID) STUDENT_COUNT\n",
    "        FROM STUDENTS\n",
    "        WHERE FAMILY_INCOME_LEVEL = 'Low' AND STRESS_LEVEL > 7\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "#result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 289,
   "id": "769be061-7e3b-4094-aa0f-428557a3e8dd",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Show the top 3 most common grades.\n",
    "query = '''\n",
    "        WITH GRADE_COUNT AS (\n",
    "            SELECT GRADE, COUNT(STUDENT_ID) STUDENT_COUNT\n",
    "            FROM STUDENTS\n",
    "            GROUP BY GRADE\n",
    "        ), TOP_3 AS (\n",
    "            SELECT GRADE, STUDENT_COUNT, RANK()OVER(ORDER BY STUDENT_COUNT DESC) RANK\n",
    "            FROM GRADE_COUNT\n",
    "        )\n",
    "        SELECT *\n",
    "        FROM TOP_3 \n",
    "        WHERE RANK <= 3\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "#result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 299,
   "id": "22f36f40-77d3-4cda-9b5c-1fd9e3db0913",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "+----------+----------+---------+-----------+----+\n",
      "|STUDENT_ID|FIRST_NAME|LAST_NAME|TOTAL_SCORE|RANK|\n",
      "+----------+----------+---------+-----------+----+\n",
      "|     S5640|      Liam|  Johnson|      99.99|   1|\n",
      "|     S5319|      John|    Davis|      99.98|   2|\n",
      "|     S1731|       Ali|    Smith|       99.9|   3|\n",
      "|     S3987|      John| Williams|       99.9|   3|\n",
      "|     S3158|      Sara|    Smith|      99.85|   5|\n",
      "+----------+----------+---------+-----------+----+\n",
      "\n"
     ]
    }
   ],
   "source": [
    "# Who are the top 5 students in terms of total score but sleep less than 6 hours per night?\n",
    "query = '''\n",
    "        WITH TOP_5 AS (\n",
    "            SELECT STUDENT_ID, FIRST_NAME, LAST_NAME, TOTAL_SCORE, RANK()OVER(ORDER BY TOTAL_SCORE DESC) RANK\n",
    "            FROM STUDENTS\n",
    "            WHERE SLEEP_HOURS_PER_NIGHT <= 6\n",
    "        )\n",
    "        SELECT *\n",
    "        FROM TOP_5\n",
    "        WHERE RANK <= 5\n",
    "    '''\n",
    "result = spark.sql(query)\n",
    "result.show()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 301,
   "id": "3223f78a-20a9-4caf-b8df-82f87aa8c782",
   "metadata": {},
   "outputs": [],
   "source": [
    "# Conver my result to a Pandas Dataframe. PySpark is not working well to conver it into a parquet/csv file.\n",
    "pandas_df = result.toPandas()\n",
    "#path = os.path.join(output_dir, 'student_results.parquet')\n",
    "#pandas_df.to_parquet(path, engine='pyarrow') \n",
    "path = os.path.join(output_dir, 'Top_Five_Total_Score.csv')\n",
    "pandas_df.to_csv(path, index=False)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "a709bba5-446c-4798-8297-7af439799d87",
   "metadata": {},
   "outputs": [],
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3.13 (with Kaggle)",
   "language": "python",
   "name": "py313"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.13.1"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
